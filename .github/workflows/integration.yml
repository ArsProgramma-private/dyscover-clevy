name: Integration Tests (manual)

on:
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Set to true to run integration tests' 
        required: true
        default: 'false'

jobs:
  integration:
    name: Integration tests (manual trigger â€” hardware)
    # Only run if integration run was requested AND the repository has a secret configured for gated runs
    if: ${{ github.event.inputs.run_integration == 'true' && secrets.INTEGRATION_RUN_TOKEN != '' }}
    # This job is intended to run on a self-hosted machine that has attached hardware
    runs-on: [self-hosted, linux, hardware]
    steps:
      - uses: actions/checkout@v4

      - name: Installing / verifying system dependencies for integration tests
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.0-gtk3-dev portaudio19-dev gettext

      - name: Configure (enable integration tests)
        run: |
          cmake -S . -B build-integration -DBUILD_TESTS=ON -DBUILD_INTEGRATION_TESTS=ON -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=ON

      - name: Build integration tests
        run: cmake --build build-integration --target Integration-DeviceDetectionStaticList -j 2 || true

      - name: Run integration tests
        run: |
          # This job is already gated by the run_integration input and presence of INTEGRATION_RUN_TOKEN
          # It should only execute on a self-hosted hardware runner with actual devices attached.
          ctest --test-dir build-integration --output-on-failure || true

      - name: Post-run artifact gathering (optional)
        if: ${{ always() }}
        run: |
          echo "Note: this job runs on self-hosted hardware. Add logs/artifacts collection here as needed."
