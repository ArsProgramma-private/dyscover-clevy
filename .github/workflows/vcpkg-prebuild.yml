name: Prebuild vcpkg packages

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch: {}
  schedule:
    # weekly cache refresh (UTC Sunday 02:00)
    - cron: '0 2 * * 0'

jobs:
  vcpkg-prebuild:
    name: Build & cache vcpkg packages (Windows)
    runs-on: windows-2022
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      CMAKE_GENERATOR: "Visual Studio 17 2022"
      VCPKG_DEFAULT_TRIPLET: x64-windows
    steps:
      - uses: actions/checkout@v4

      - name: Create vcpkg.json manifest
        shell: powershell
        run: |
          $manifest = @'
          {
            "dependencies": [
              { "name": "wxwidgets", "features": ["sound"] },
              "portaudio",
              { "name": "gettext", "features": ["tools"] }
            ]
          }
          '@
          $manifest | Out-File -FilePath vcpkg.json -Encoding utf8

      - name: Checkout microsoft/vcpkg
        uses: actions/checkout@v4
        with:
          repository: microsoft/vcpkg
          path: vcpkg
          ref: 75cdbf55732bc8f36e8286d0254feb8083a6dd2a
          fetch-depth: 1

      # Use a stable cache key that depends on the pinned vcpkg commit and the
      # vcpkg/versions/** files. Avoid using the ephemeral vcpkg.json hash here
      # because it can differ in tiny ways (line endings/whitespace) between
      # workflows and lead to mismatched cache keys.
      - name: Restore vcpkg cache
        uses: actions/cache@v4
        id: vcpkg-cache-restore
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
            vcpkg/buildtrees
          key: vcpkg-${{ runner.os }}-vcpkg-75cdbf55732bc8f36e8286d0254feb8083a6dd2a-${{ hashFiles('vcpkg/versions/**') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-vcpkg-75cdbf55732bc8f36e8286d0254feb8083a6dd2a-
            vcpkg-${{ runner.os }}-

      - name: Bootstrap vcpkg
        shell: pwsh
        working-directory: vcpkg
        run: |
          .\bootstrap-vcpkg.bat -disableMetrics

      - name: Install vcpkg packages
        id: vcpkg-install
        shell: pwsh
        working-directory: vcpkg
        run: |
          if (Test-Path installed/x64-windows) {
            Write-Host "Cache restored, verifying packages..."
          }
          .\vcpkg.exe install --recurse --clean-after-build --triplet $env:VCPKG_DEFAULT_TRIPLET

      - name: Save vcpkg cache (no-op if already up-to-date)
        uses: actions/cache@v4
        if: steps.vcpkg-cache-restore.outputs.cache-hit != 'true'
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
            vcpkg/buildtrees
          key: vcpkg-${{ runner.os }}-vcpkg-75cdbf55732bc8f36e8286d0254feb8083a6dd2a-${{ hashFiles('vcpkg/versions/**') }}

      - name: Save canonical (fallback) vcpkg cache
        # Also save a canonical cache that only depends on the pinned vcpkg commit
        # and runner.os. This allows release/tag builds on different refs to
        # reuse a recent prebuild when the versions/** hash does not match.
        uses: actions/cache@v4
        with:
          path: |
            vcpkg/installed
            vcpkg/packages
            vcpkg/buildtrees
          key: vcpkg-${{ runner.os }}-vcpkg-75cdbf55732bc8f36e8286d0254feb8083a6dd2a
          restore-keys: |
            vcpkg-${{ runner.os }}-vcpkg-75cdbf55732bc8f36e8286d0254feb8083a6dd2a-
            vcpkg-${{ runner.os }}-

      - name: Upload some cache manifest
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-prebuild-win
          path: |
            vcpkg/installed
          if-no-files-found: ignore

      - name: Done
        run: echo "vcpkg prebuild complete"
