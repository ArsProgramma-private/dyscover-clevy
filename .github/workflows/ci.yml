name: CI - C++ Standard Matrix
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-build:
    name: Linux build (GCC >= 9)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Cache build dir
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-build-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.2-dev portaudio19-dev gettext

      - name: Configure (C++17)
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          ${CXX:-g++} -std=c++17 test.cpp -O2 -o test && ./test

  linux-full-build:
    name: Linux full product build
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Setup ccache cache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Cache build directory
        uses: actions/cache@v4
        with:
          path: build-full
          key: ${{ runner.os }}-build-full-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-build-full-

      - name: Install packages (full product build)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.2-dev portaudio19-dev gettext libasound2-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev

      - name: Configure (C++17 — full build)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build-full \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_CXX20=OFF \
            -DBUILD_TESTS=OFF \
            -DBUILD_WITH_LIBRSTTS=OFF \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build (full product)
        run: cmake --build build-full --target Dyscover -j 2

      - name: Run smoke-run (if executable produced)
        run: |
          if [ -f build-full/Dyscover ]; then echo "Dyscover produced"; file build-full/Dyscover || true; else echo "No Dyscover executable found"; fi

      - name: Verify hardening (Linux)
        run: |
          chmod +x scripts/verify-hardening.sh
          if [ -f build-full/Dyscover ]; then ./scripts/verify-hardening.sh build-full/Dyscover || true; fi

      - name: Audit dependencies (with SHA256)
        run: |
          chmod +x scripts/audit-deps.sh
          if [ -f build-full/Dyscover ]; then ./scripts/audit-deps.sh Dyscover build-full > audit-linux.txt || true; cat audit-linux.txt; fi

      - name: Generate SBOM
        run: |
          chmod +x scripts/generate-sbom.sh
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          if [ -f build-full/Dyscover ]; then ./scripts/generate-sbom.sh build-full/Dyscover || true; fi

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-linux
          path: |
            sbom/
            audit-linux.txt

  macos-build:
    name: macOS build (Clang >= 10)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Homebrew
        run: |
          brew update || true
          brew install cmake pkg-config wxwidgets portaudio gettext || true

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: macos-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            macos-ccache-

      - name: Configure (C++17)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || brew install ccache || true
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          clang++ -std=c++17 test.cpp -O2 -o test && ./test

  windows-check:
    name: Windows compiler check (MSVC >= 2019)
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create and compile test file
        shell: cmd
        run: |
          echo #include ^<iostream^> > test.cpp
          echo int main(){ std::cout ^<^< __cplusplus ^<^< std::endl; return 0; } >> test.cpp
          cl /EHsc /std:c++17 test.cpp /Fe:test.exe
          test.exe

  linux-cxx20:
    name: Linux C++20 validation
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache (C++20 job)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-cxx20-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Install packages (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config

      - name: Configure with C++20
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build-cxx20 -DENABLE_CXX20=ON -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Build (C++20 smoke)
        run: cmake --build build-cxx20 --target Dyscover -j 2 || true

  linux-tests:
    name: Linux unit tests
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache (tests)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-tests-${{ hashFiles('**/CMakeLists.txt','**/tests/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Install minimal packages for tests
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config

      - name: Configure (build tests)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build-tests -DBUILD_TESTS=ON -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Build tests
        run: cmake --build build-tests --target DeviceStaticListTest -j 2

      - name: Run tests
        run: ctest --test-dir build-tests --output-on-failure || true

  macos-full-build:
      name: macOS full product build
      runs-on: macos-latest
      needs: macos-build
      steps:
        - uses: actions/checkout@v4

        - name: Cache macOS build dir
          uses: actions/cache@v4
          with:
            path: build-mac
            key: macos-build-full-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
            restore-keys: |
              macos-build-full-

        - name: Install packages (full product)
          run: |
            brew update || true
            brew install cmake pkg-config wxwidgets portaudio gettext || true

        - name: Configure (C++17 — full build)
          env:
            CCACHE_DIR: ${{ runner.temp }}/ccache
          run: |
            mkdir -p ${CCACHE_DIR}
            ccache --version || brew install ccache || true
            cmake -S . -B build-mac -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

        - name: Build (full product)
          run: cmake --build build-mac --target Dyscover -j 2 || true

        - name: Verify hardening (macOS)
          run: |
            chmod +x scripts/verify-hardening.sh
            if [ -f build-mac/Dyscover ]; then ./scripts/verify-hardening.sh build-mac/Dyscover || true; fi

        - name: Audit dependencies (with SHA256)
          run: |
            chmod +x scripts/audit-deps.sh
            if [ -f build-mac/Dyscover ]; then ./scripts/audit-deps.sh Dyscover build-mac > audit-macos.txt || true; cat audit-macos.txt; fi

        - name: Generate SBOM
          run: |
            chmod +x scripts/generate-sbom.sh
            curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
            if [ -f build-mac/Dyscover ]; then ./scripts/generate-sbom.sh build-mac/Dyscover || true; fi

        - name: Upload SBOM artifacts
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: sbom-macos
            path: |
              sbom/
              audit-macos.txt

  windows-full-build:
      name: Windows full product build
      runs-on: windows-2022
      needs: windows-check
      steps:
        - uses: actions/checkout@v4

        - name: Setup MSVC
          uses: ilammy/msvc-dev-cmd@v1

        - name: Setup vcpkg
          uses: lukka/run-vcpkg@v11
          with:
            vcpkgGitCommitId: 'c8696863d371ab7f46e213d8f5ca923c4aef2a00'

        - name: Install wxWidgets via vcpkg
          shell: powershell
          run: |
            vcpkg install wxwidgets:x64-windows

        - name: Cache Windows build dir
          uses: actions/cache@v4
          with:
            path: build-win
            key: windows-build-full-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
            restore-keys: |
              windows-build-full-

        - name: Configure (Visual Studio generator x64)
          shell: powershell
          run: |
            cmake -S . -B build-win `
              -G "Visual Studio 17 2022" -A x64 `
              -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
              -DENABLE_CXX20=OFF `
              -DBUILD_WITH_LIBRSTTS=OFF `
              -DBUILD_WITH_PORTAUDIO=OFF

        - name: Build (full product)
          shell: powershell
          run: |
            cmake --build build-win --config Release --target Dyscover || true

        - name: Verify hardening (Windows)
          shell: powershell
          run: |
            if (Test-Path build-win\Release\Dyscover.exe) { pwsh .\scripts\verify-hardening.ps1 -Binary build-win\Release\Dyscover.exe } else { Write-Host 'Binary not found' }
          continue-on-error: true

        - name: Audit dependencies (with SHA256)
          shell: powershell
          run: |
            if (Test-Path build-win\Release\Dyscover.exe) { pwsh .\scripts\audit-deps.ps1 -Target Dyscover.exe -BuildDir build-win\Release | Tee-Object -FilePath audit-windows.txt; Get-Content audit-windows.txt }
          continue-on-error: true

        - name: Upload audit artifacts
          uses: actions/upload-artifact@v4
          if: always()
          with:
            name: audit-windows
            path: audit-windows.txt
