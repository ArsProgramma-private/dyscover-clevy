name: CI - C++ Standard Matrix
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-build:
    name: Linux build (GCC >= 9)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Cache build dir
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-build-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.2-dev portaudio19-dev gettext

      - name: Configure (C++17)
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          ${CXX:-g++} -std=c++17 test.cpp -O2 -o test && ./test

  macos-build:
    name: macOS build (Clang >= 10)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Homebrew
        run: |
          brew update || true
          brew install cmake pkg-config wxwidgets portaudio gettext || true

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: macos-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            macos-ccache-

      - name: Configure (C++17)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || brew install ccache || true
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          clang++ -std=c++17 test.cpp -O2 -o test && ./test

  windows-check:
    name: Windows compiler check (MSVC >= 2019)
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create and compile test file
        shell: cmd
        run: |
          echo #include ^<iostream^> > test.cpp
          echo int main(){ std::cout ^<^< __cplusplus ^<^< std::endl; return 0; } >> test.cpp
          cl /EHsc /std:c++17 test.cpp /Fe:test.exe
          test.exe

