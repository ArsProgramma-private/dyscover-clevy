name: CI - C++ Standard Matrix
 
on:
  push:
    branches: [ main, '001-upgrade-cpp17', '**/001-*' ]
  pull_request:
    branches: [ main ]

jobs:
  linux-build:
    name: Linux build (GCC >= 9)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.0-gtk3-dev portaudio19-dev gettext

      - name: Configure (C++17)
        run: |
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          ${CXX:-g++} -std=c++17 test.cpp -O2 -o test && ./test

  linux-full-build:
    name: Linux full product build
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Install packages (full product build)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev portaudio19-dev gettext libasound2-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev

      - name: Configure (C++17 â€” full build)
        run: |
          cmake -S . -B build-full -DENABLE_CXX20=OFF

      - name: Build (full product)
        run: cmake --build build-full --target Dyscover -j 2

      - name: Run smoke-run (if executable produced)
        run: |
          if [ -f build-full/Dyscover ]; then echo "Dyscover produced"; file build-full/Dyscover || true; else echo "No Dyscover executable found"; fi

  macos-build:
    name: macOS build (Clang >= 10)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Homebrew
        run: |
          brew update || true
          brew install cmake pkg-config wxwidgets portaudio gettext || true

      - name: Configure (C++17)
        run: |
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          clang++ -std=c++17 test.cpp -O2 -o test && ./test

  windows-check:
    name: Windows compiler check (MSVC >= 2019)
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Create test file
        run: |
          echo #include <iostream> > test.cpp
          echo int main(){ std::cout << __cplusplus << '\n'; return 0; } >> test.cpp

      - name: Compile with MSVC (check C++17)
        shell: cmd
        run: |
          cl /EHsc /std:c++17 test.cpp

  linux-cxx20:
    name: Linux C++20 validation
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Install packages (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config

      - name: Configure with C++20
        run: |
          cmake -S . -B build-cxx20 -DENABLE_CXX20=ON -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF

      - name: Build (C++20 smoke)
        run: cmake --build build-cxx20 --target Dyscover -j 2 || true
