name: CI - C++ Standard Matrix
 
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  linux-build:
    name: Linux build (GCC >= 9)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-
          retention-days: 14

      - name: Cache build dir
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-build-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-build-
          retention-days: 14

      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.0-gtk3-dev portaudio19-dev gettext

      - name: Configure (C++17)
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          ${CXX:-g++} -std=c++17 test.cpp -O2 -o test && ./test

  linux-full-build:
    name: Linux full product build
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - name: Setup ccache cache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-
          retention-days: 14

      - name: Cache build directory
        uses: actions/cache@v4
        with:
          path: build-full
          key: ${{ runner.os }}-build-full-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-build-full-
          retention-days: 14

      - uses: actions/checkout@v4

      - name: Install packages (full product build)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config libudev-dev libwxgtk3.0-gtk3-dev libwxgtk-media3.0-gtk3-dev portaudio19-dev gettext libasound2-dev libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev

      - name: Configure (C++17 — full build)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build-full -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build (full product)
        run: cmake --build build-full --target Dyscover -j 2

      - name: Run smoke-run (if executable produced)
        run: |
          if [ -f build-full/Dyscover ]; then echo "Dyscover produced"; file build-full/Dyscover || true; else echo "No Dyscover executable found"; fi

  macos-build:
    name: macOS build (Clang >= 10)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare Homebrew
        run: |
          brew update || true
          brew install cmake pkg-config wxwidgets portaudio gettext || true

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: macos-ccache-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            macos-ccache-
          retention-days: 14

      - name: Configure (C++17)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || brew install ccache || true
          cmake -S . -B build -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Smoke compile and run small test (C++17)
        run: |
          cat > test.cpp <<'EOF'
          #include <iostream>
          #include <string>
          int main(){ std::string s = "C++17 smoke test"; std::cout << s << "\n"; return 0; }
          EOF
          clang++ -std=c++17 test.cpp -O2 -o test && ./test

  windows-check:
    name: Windows compiler check (MSVC >= 2019)
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Create test file
        run: |
          echo #include <iostream> > test.cpp
          echo int main(){ std::cout << __cplusplus << '\n'; return 0; } >> test.cpp

      - name: Compile with MSVC (check C++17)
        shell: cmd
        run: |
          cl /EHsc /std:c++17 test.cpp

  linux-cxx20:
    name: Linux C++20 validation
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache (C++20 job)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-cxx20-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Install packages (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config

      - name: Configure with C++20
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build-cxx20 -DENABLE_CXX20=ON -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Build (C++20 smoke)
        run: cmake --build build-cxx20 --target Dyscover -j 2 || true

  linux-tests:
    name: Linux unit tests
    runs-on: ubuntu-latest
    needs: linux-build
    steps:
      - uses: actions/checkout@v4

      - name: Cache ccache (tests)
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-tests-${{ hashFiles('**/CMakeLists.txt','**/tests/**') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Install minimal packages for tests
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential cmake pkg-config

      - name: Configure (build tests)
        env:
          CCACHE_DIR: ${{ runner.temp }}/ccache
        run: |
          mkdir -p ${CCACHE_DIR}
          ccache --version || sudo apt-get install -y ccache || true
          cmake -S . -B build-tests -DBUILD_TESTS=ON -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        # (single run block above uses ccache-aware configure)

      - name: Build tests
        run: cmake --build build-tests --target DeviceStaticListTest -j 2

      - name: Run tests
        run: ctest --test-dir build-tests --output-on-failure || true

  macos-full-build:
      name: macOS full product build
      runs-on: macos-latest
      needs: macos-build
      steps:
        - uses: actions/checkout@v4

        - name: Install packages (full product)
          run: |
            brew update || true
            brew install cmake pkg-config wxwidgets portaudio gettext || true

        - name: Cache macOS build dir
          uses: actions/cache@v4
          with:
            path: build-mac
            key: macos-build-full-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
            restore-keys: |
              macos-build-full-
            retention-days: 14

        - name: Configure (C++17 — full build)
          env:
            CCACHE_DIR: ${{ runner.temp }}/ccache
          run: |
            mkdir -p ${CCACHE_DIR}
            ccache --version || brew install ccache || true
            cmake -S . -B build-mac -DENABLE_CXX20=OFF -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

        - name: Build (full product)
          run: cmake --build build-mac --target Dyscover -j 2 || true

  windows-full-build:
      name: Windows full product build
      runs-on: windows-2022
      needs: windows-check
      steps:
        - uses: actions/checkout@v4

        - name: Configure (Visual Studio generator x64)
          shell: powershell
          run: |
            mkdir build-win
            cmake -S . -B build-win -G "Visual Studio 17 2022" -A x64 -DENABLE_CXX20=OFF -DBUILD_WITH_LIBRSTTS=OFF -DBUILD_WITH_PORTAUDIO=OFF

        - name: Cache Windows build dir
          uses: actions/cache@v4
          with:
            path: build-win
            key: windows-build-full-${{ hashFiles('**/CMakeLists.txt','**/src/**') }}
            restore-keys: |
              windows-build-full-

        - name: Build (full product)
          shell: powershell
          run: |
            cmake --build build-win --config Release --target Dyscover || true
